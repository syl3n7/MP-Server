@{
    ViewData["Title"] = "Racing Server Dashboard";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .dashboard-card {
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .refresh-button {
            margin-bottom: 20px;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .table-responsive {
            margin-bottom: 0;
        }
        .active-badge {
            background-color: #28a745;
            color: white;
        }
        .inactive-badge {
            background-color: #6c757d;
            color: white;
        }
        .admin-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .admin-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }
        .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn-danger {
            margin-right: 5px;
        }
        .security-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .security-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #856404;
        }
        .threat-level-0 { color: #28a745; }
        .threat-level-1 { color: #ffc107; }
        .threat-level-2 { color: #fd7e14; }
        .threat-level-3 { color: #dc3545; }
        .security-metric {
            display: inline-block;
            margin-right: 15px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .security-metric.low { background-color: #d4edda; color: #155724; }
        .security-metric.medium { background-color: #fff3cd; color: #856404; }
        .security-metric.high { background-color: #f8d7da; color: #721c24; }
        .security-tab {
            display: none;
        }
        .security-tab.active {
            display: block;
        }
        .nav-tabs .nav-link.active {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .event-timestamp {
            font-size: 11px;
            color: #6c757d;
        }
        .severity-1 { color: #6c757d; }
        .severity-2 { color: #17a2b8; }
        .severity-3 { color: #ffc107; }
        .severity-4 { color: #fd7e14; }
        .severity-5 { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">@ViewData["Title"]</h1>
        
        <button id="refreshButton" class="btn btn-primary refresh-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
            Refresh Data
        </button>
        
        <!-- Server Management Section -->
        <div class="admin-section">
            <h2 class="admin-title">🚀 Server Management</h2>
            
            <!-- Server Status -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-value" id="serverStatus">Loading...</div>
                        <div class="stat-label">Server Status</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-value" id="serverUptime">-</div>
                        <div class="stat-label">Server Uptime</div>
                    </div>
                </div>
            </div>
            
            <!-- Server Configuration -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Server Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="tcpPort" class="form-label">TCP Port</label>
                                <input type="number" class="form-control" id="tcpPort" value="443" min="1" max="65535">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="udpPort" class="form-label">UDP Port</label>
                                <input type="number" class="form-control" id="udpPort" value="443" min="1" max="65535">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check" style="margin-top: 32px;">
                                <input class="form-check-input" type="checkbox" id="useTls" checked>
                                <label class="form-check-label" for="useTls">
                                    Use TLS/SSL
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        Database configuration is loaded from <code>appsettings.json</code>. 
                        Environment: <strong id="environmentName">Loading...</strong>
                    </div>
                </div>
            </div>
            
            <!-- Server Controls -->
            <div class="admin-buttons">
                <button id="startServerButton" class="btn btn-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M6.271 5.055a.5.5 0 0 1 .52.038L11 7.055a.5.5 0 0 1 0 .89L6.791 9.907a.5.5 0 0 1-.791-.39V5.383a.5.5 0 0 1 .271-.328"/>
                    </svg>
                    Start Server
                </button>
                <button id="stopServerButton" class="btn btn-danger" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5z"/>
                    </svg>
                    Stop Server
                </button>
            </div>
            
            <div id="serverOperationResult" class="mt-3"></div>
        </div>
        
        <div class="admin-section">
            <h2 class="admin-title">Admin Controls</h2>
            <div class="admin-buttons">
                <button id="closeAllRoomsButton" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                    Close All Rooms
                </button>
                <button id="disconnectAllButton" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-x" viewBox="0 0 16 16">
                        <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m.256 7a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
                        <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m-.646-4.854.646.647.646-.647a.5.5 0 0 1 .708.708l-.647.646.647.646a.5.5 0 0 1-.708.708l-.646-.647-.646.647a.5.5 0 0 1-.708-.708l.647-.646-.647-.646a.5.5 0 0 1 .708-.708"/>
                    </svg>
                    Disconnect All Players
                </button>
            </div>
            <div id="selectedItemActions" style="display: none;">
                <h5>Selected Item Actions:</h5>
                <div class="admin-buttons" id="itemActionButtons">
                    <!-- Action buttons will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <div class="security-section">
            <h2 class="security-title">🛡️ Security Monitoring</h2>
            
            <ul class="nav nav-tabs" id="securityTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-tab="overview" type="button" role="tab">Overview</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="events-tab" data-tab="events" type="button" role="tab">Security Events</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="players-tab" data-tab="players" type="button" role="tab">Player Security</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ratelimit-tab" data-tab="ratelimit" type="button" role="tab">Rate Limits</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-tab="users" type="button" role="tab">User Management</button>
                </li>
            </ul>
            
            <div class="tab-content" id="securityTabContent">
                <div class="tab-pane fade show active security-tab" id="overview" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalEvents">0</div>
                                <div class="stat-label">Total Events</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="recentEvents">0</div>
                                <div class="stat-label">Recent Events (5m)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="highThreatPlayers">0</div>
                                <div class="stat-label">High Threat Players</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="securityStatus">🟢</div>
                                <div class="stat-label">Security Status</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h5>Event Types (Last 100)</h5>
                        <div id="eventTypesChart">
                            <!-- Event types breakdown will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade security-tab" id="events" role="tabpanel">
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm" id="securityEventsTable">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Player</th>
                                        <th>Description</th>
                                        <th>Severity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Security events will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade security-tab" id="players" role="tabpanel">
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm" id="playerSecurityTable">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Threat Level</th>
                                        <th>Violations</th>
                                        <th>Recent</th>
                                        <th>Auth</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Player security data will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade security-tab" id="ratelimit" role="tabpanel">
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm" id="rateLimitTable">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>TCP Rate</th>
                                        <th>UDP Rate</th>
                                        <th>TCP Usage</th>
                                        <th>UDP Usage</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rate limit data will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade security-tab" id="users" role="tabpanel">
                    <div class="mt-3">
                        <!-- User Management Statistics -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="totalUsers">0</div>
                                    <div class="stat-label">Total Users</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="activeUsers">0</div>
                                    <div class="stat-label">Active Users</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="bannedUsers">0</div>
                                    <div class="stat-label">Banned Users</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="onlineUsers">0</div>
                                    <div class="stat-label">Online Now</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Management Actions -->
                        <div class="admin-buttons mb-3">
                            <button id="refreshUsersBtn" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                                </svg>
                                Refresh Users
                            </button>
                            <input type="text" id="userSearchInput" class="form-control" placeholder="Search users..." style="max-width: 200px; display: inline-block;">
                        </div>
                        
                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Last Login</th>
                                        <th>Login Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- User data will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="usersPagination" class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <span id="usersPageInfo">Page 1 of 1</span>
                            </div>
                            <div>
                                <button id="prevUsersPage" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                                <button id="nextUsersPage" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <!-- Stats cards will be inserted here -->
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">Active Rooms</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="roomsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Players</th>
                                        <th>Status</th>
                                        <th>Age</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Room data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">Active Sessions</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="sessionsTable">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Room</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Session data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Load data on page load
            loadAllData();
            
            // Set up auto-refresh every 10 seconds
            setInterval(loadAllData, 10000);
            
            // Manual refresh button
            $("#refreshButton").click(function() {
                loadAllData();
            });

            // Security tab switching
            $("#securityTabs button[data-tab]").click(function() {
                const targetTab = $(this).data("tab");
                
                // Update tab appearance
                $("#securityTabs button").removeClass("active");
                $(this).addClass("active");
                
                // Show/hide tab content
                $(".security-tab").removeClass("show active");
                $(`#${targetTab}`).addClass("show active");
            });

            // Admin buttons
            $("#closeAllRoomsButton").click(function() {
                if (confirm("Are you sure you want to close all rooms?")) {
                    $.post("/Dashboard/CloseAllRooms", function(data) {
                        alert(data.message);
                        loadAllData();
                    });
                }
            });
            
            $("#disconnectAllButton").click(function() {
                if (confirm("Are you sure you want to disconnect all players?")) {
                    $.post("/Dashboard/DisconnectAllPlayers", function(data) {
                        alert(data.message);
                        loadAllData();
                    });
                }
            });
            
            // Server Management buttons
            $("#startServerButton").click(function() {
                const config = {
                    tcpPort: parseInt($("#tcpPort").val()),
                    udpPort: parseInt($("#udpPort").val()),
                    useTls: $("#useTls").is(':checked')
                };
                
                $(this).prop('disabled', true).text('Starting...');
                
                $.post("/ServerManagement/dashboard-start", config, function(data) {
                    showServerOperationResult(data.success, data.message);
                    if (data.success) {
                        updateServerControlButtons(true);
                    }
                    loadServerStatus();
                }).fail(function() {
                    showServerOperationResult(false, "Failed to start server");
                }).always(function() {
                    $("#startServerButton").prop('disabled', false).text('Start Server');
                });
            });
                        showServerOperationResult(false, "Failed to start server");
                    },
                    complete: function() {
                        $("#startServerButton").prop('disabled', false).text('Start Server');
                    }
                });
            });
            
            $("#stopServerButton").click(function() {
                if (confirm("Are you sure you want to stop the server? This will disconnect all players.")) {
                    $(this).prop('disabled', true).text('Stopping...');
                    
                    $.post("/ServerManagement/dashboard-stop", function(data) {
                        showServerOperationResult(data.success, data.message);
                        if (data.success) {
                            updateServerControlButtons(false);
                        }
                        loadServerStatus();
                    }).fail(function() {
                        showServerOperationResult(false, "Failed to stop server");
                    }).always(function() {
                        $("#stopServerButton").prop('disabled', false).text('Stop Server');
                    });
                }
            });
            
            // User Management Event Handlers
            $("#refreshUsersBtn").click(function() {
                loadUserManagementData();
            });
            
            $("#userSearchInput").on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterUsersTable(searchTerm);
            });
            
            $("#prevUsersPage").click(function() {
                if (currentUserPage > 1) {
                    currentUserPage--;
                    loadUsers();
                }
            });
            
            $("#nextUsersPage").click(function() {
                if (currentUserPage < totalUserPages) {
                    currentUserPage++;
                    loadUsers();
                }
            });
            
            // User management variables
            let currentUserPage = 1;
            let totalUserPages = 1;
            let usersPerPage = 20;
            
            function loadAllData() {
                loadServerStatus();
                loadStats();
                loadRooms();
                loadSessions();
                loadSecurityData();
                loadUserManagementData();
            }
            
            function loadStats() {
                $.getJSON("/Dashboard/GetStats", function(data) {
                    if (data.error) {
                        // Server is not running, show default values
                        $("#statsContainer").empty();
                        $("#statsContainer").append(createStatCard("Server Uptime", "Server not running"));
                        $("#statsContainer").append(createStatCard("Active Sessions", "0"));
                        $("#statsContainer").append(createStatCard("Total Rooms", "0"));
                        $("#statsContainer").append(createStatCard("Active Games", "0"));
                        $("#statsContainer").append(createStatCard("Players In Rooms", "0"));
                        return;
                    }
                    
                    // Format uptime nicely
                    let uptimeStr = formatTimeSpan(data.uptime);
                    
                    // Clear and rebuild stats container
                    $("#statsContainer").empty();
                    
                    // Add stat cards
                    $("#statsContainer").append(createStatCard("Server Uptime", uptimeStr));
                    $("#statsContainer").append(createStatCard("Active Sessions", data.activeSessions));
                    $("#statsContainer").append(createStatCard("Total Rooms", data.totalRooms));
                    $("#statsContainer").append(createStatCard("Active Games", data.activeGames));
                    $("#statsContainer").append(createStatCard("Players In Rooms", data.playersInRooms));
                }).fail(function() {
                    // Handle connection error
                    $("#statsContainer").empty();
                    $("#statsContainer").append(createStatCard("Server Status", "Connection Error"));
                });
            }
            
            function createStatCard(label, value) {
                return `<div class="stat-card">
                    <div class="stat-value">${value}</div>
                    <div class="stat-label">${label}</div>
                </div>`;
            }
            
            // Server Management Functions
            function loadServerStatus() {
                $.getJSON("/ServerManagement/dashboard-status", function(data) {
                    if (data.isRunning) {
                        $("#serverStatus").text("Running").css("color", "#28a745");
                        $("#serverUptime").text(data.startTime ? getTimeAgo(new Date(data.startTime)) : "-");
                        updateServerControlButtons(true);
                    } else {
                        $("#serverStatus").text("Stopped").css("color", "#dc3545");
                        $("#serverUptime").text("-");
                        updateServerControlButtons(false);
                    }
                    
                    // Show environment info
                    if (data.environment) {
                        $("#environmentName").text(data.environment);
                    }
                }).fail(function() {
                    $("#serverStatus").text("Unknown").css("color", "#6c757d");
                    $("#serverUptime").text("-");
                    $("#environmentName").text("Unknown");
                    updateServerControlButtons(false);
                });
            }
            
            function updateServerControlButtons(isRunning) {
                if (isRunning) {
                    $("#startServerButton").prop('disabled', true);
                    $("#stopServerButton").prop('disabled', false);
                } else {
                    $("#startServerButton").prop('disabled', false);
                    $("#stopServerButton").prop('disabled', true);
                }
            }
            
            function showServerOperationResult(success, message) {
                const resultDiv = $("#serverOperationResult");
                resultDiv.empty();
                
                const alertClass = success ? "alert-success" : "alert-danger";
                const icon = success ? "bi-check-circle" : "bi-x-circle";
                
                resultDiv.html(`
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="bi ${icon}"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    resultDiv.find('.alert').alert('close');
                }, 10000);
            }
            
            function loadRooms() {
                $.getJSON("/Dashboard/GetRooms", function(data) {
                    let tbody = $("#roomsTable tbody");
                    tbody.empty();
                    
                    if (data.error) {
                        tbody.append('<tr><td colspan="5" class="text-center text-muted">Server not running</td></tr>');
                        return;
                    }
                    
                    if (data.length === 0) {
                        tbody.append('<tr><td colspan="5" class="text-center">No rooms available</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(room) {
                        let age = getTimeAgo(new Date(room.createdAt));
                        let statusBadge = room.isActive 
                            ? '<span class="badge active-badge">Active</span>' 
                            : '<span class="badge inactive-badge">Lobby</span>';
                            
                        tbody.append(`<tr data-id="${room.id}" data-type="room">
                            <td>${escapeHtml(room.name)}</td>
                            <td>${room.playerCount}</td>
                            <td>${statusBadge}</td>
                            <td>${age}</td>
                            <td>
                                <button class="btn btn-sm btn-danger closeRoomBtn" data-id="${room.id}">Close</button>
                            </td>
                        </tr>`);
                    });
                    
                    // Add event handlers for room actions
                    $(".closeRoomBtn").click(function() {
                        const roomId = $(this).data("id");
                        if (confirm("Are you sure you want to close this room?")) {
                            $.post("/Dashboard/CloseRoom", { roomId: roomId }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                    
                    // Add row click handler for room selection
                    $("#roomsTable tbody tr").click(function() {
                        $("#roomsTable tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        
                        const roomId = $(this).data("id");
                        showItemActions("room", roomId);
                    });
                });
            }
            
            function loadSessions() {
                $.getJSON("/Dashboard/GetSessions", function(data) {
                    let tbody = $("#sessionsTable tbody");
                    tbody.empty();
                    
                    if (data.error) {
                        tbody.append('<tr><td colspan="4" class="text-center text-muted">Server not running</td></tr>');
                        return;
                    }
                    
                    if (data.length === 0) {
                        tbody.append('<tr><td colspan="4" class="text-center">No active sessions</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(session) {
                        let lastActivity = getTimeAgo(new Date(session.lastActivity));
                        let roomDisplay = session.currentRoomId ? session.currentRoomId : 'None';
                        
                        tbody.append(`<tr data-id="${session.id}" data-type="session">
                            <td>${escapeHtml(session.name)}</td>
                            <td>${escapeHtml(roomDisplay)}</td>
                            <td>${lastActivity}</td>
                            <td>
                                <button class="btn btn-sm btn-danger disconnectBtn" data-id="${session.id}">Disconnect</button>
                            </td>
                        </tr>`);
                    });
                    
                    // Add event handlers for session actions
                    $(".disconnectBtn").click(function() {
                        const sessionId = $(this).data("id");
                        if (confirm("Are you sure you want to disconnect this player?")) {
                            $.post("/Dashboard/DisconnectPlayer", { sessionId: sessionId }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                    
                    // Add row click handler for session selection
                    $("#sessionsTable tbody tr").click(function() {
                        $("#sessionsTable tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        
                        const sessionId = $(this).data("id");
                        showItemActions("session", sessionId);
                    });
                });
            }
            
            function loadSecurityData() {
                loadSecurityStats();
                loadSecurityEvents();
                loadPlayerSecurity();
                loadRateLimitData();
            }
            
            function loadSecurityStats() {
                $.getJSON("/Dashboard/GetSecurityStats", function(data) {
                    $("#totalEvents").text(data.totalEvents || 0);
                    $("#recentEvents").text(data.recentEvents || 0);
                    $("#highThreatPlayers").text(data.highThreatPlayers || 0);
                    
                    // Update security status based on recent events and threat levels
                    let status = "🟢"; // Green
                    if (data.highThreatPlayers > 0 || data.recentEvents > 5) {
                        status = "🟡"; // Yellow
                    }
                    if (data.highThreatPlayers > 2 || data.recentEvents > 10) {
                        status = "🔴"; // Red
                    }
                    $("#securityStatus").text(status);
                    
                    // Update event types chart
                    let chartHtml = "";
                    if (data.eventsByType && Object.keys(data.eventsByType).length > 0) {
                        for (const [eventType, count] of Object.entries(data.eventsByType)) {
                            chartHtml += `<span class="security-metric medium">${eventType}: ${count}</span>`;
                        }
                    } else {
                        chartHtml = "<span class='text-muted'>No recent events</span>";
                    }
                    $("#eventTypesChart").html(chartHtml);
                });
            }
            
            function loadSecurityEvents() {
                $.getJSON("/Dashboard/GetSecurityEvents?limit=50", function(data) {
                    let tbody = $("#securityEventsTable tbody");
                    tbody.empty();
                    
                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="5" class="text-center">No security events</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(event) {
                        let timeAgo = getTimeAgo(new Date(event.timestamp));
                        let severityClass = `severity-${event.severity}`;
                        
                        tbody.append(`<tr>
                            <td><span class="event-timestamp">${timeAgo}</span></td>
                            <td><span class="badge bg-secondary">${event.eventType}</span></td>
                            <td>${escapeHtml(event.clientId.substring(0, 8))}...</td>
                            <td>${escapeHtml(event.description)}</td>
                            <td><span class="${severityClass}">●</span> ${event.severity}</td>
                        </tr>`);
                    });
                });
            }
            
            function loadPlayerSecurity() {
                $.getJSON("/Dashboard/GetPlayerSecurityDetails", function(data) {
                    let tbody = $("#playerSecurityTable tbody");
                    tbody.empty();
                    
                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="7" class="text-center">No players online</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(player) {
                        let threatClass = `threat-level-${player.threatLevel}`;
                        let authBadge = player.isAuthenticated 
                            ? '<span class="badge bg-success">✓</span>' 
                            : '<span class="badge bg-warning">✗</span>';
                        let timeAgo = getTimeAgo(new Date(player.lastActivity));
                        
                        tbody.append(`<tr>
                            <td>${escapeHtml(player.name)}</td>
                            <td><span class="${threatClass}">●</span> ${player.threatLevel}</td>
                            <td>${player.totalViolations}</td>
                            <td>${player.recentViolations}</td>
                            <td>${authBadge}</td>
                            <td>${timeAgo}</td>
                            <td>
                                <button class="btn btn-sm btn-danger banPlayerBtn" data-id="${player.id}" data-name="${escapeHtml(player.name)}">Ban</button>
                            </td>
                        </tr>`);
                    });
                    
                    // Add ban player handlers
                    $(".banPlayerBtn").click(function() {
                        const playerId = $(this).data("id");
                        const playerName = $(this).data("name");
                        const reason = prompt(`Enter ban reason for ${playerName}:`, "Security violation");
                        
                        if (reason && confirm(`Are you sure you want to ban ${playerName}?`)) {
                            $.post("/Dashboard/BanPlayer", { sessionId: playerId, reason: reason }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                });
            }
            
            function loadRateLimitData() {
                $.getJSON("/Dashboard/GetRateLimitStatus", function(data) {
                    let tbody = $("#rateLimitTable tbody");
                    tbody.empty();
                    
                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="6" class="text-center">No active sessions</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(player) {
                        let tcpUsageClass = player.tcpUtilization > 80 ? "high" : player.tcpUtilization > 50 ? "medium" : "low";
                        let udpUsageClass = player.udpUtilization > 80 ? "high" : player.udpUtilization > 50 ? "medium" : "low";
                        let timeAgo = getTimeAgo(new Date(player.lastActivity));
                        
                        tbody.append(`<tr>
                            <td>${escapeHtml(player.playerName)}</td>
                            <td>${player.tcpRate}/${player.tcpLimit}</td>
                            <td>${player.udpRate}/${player.udpLimit}</td>
                            <td><span class="security-metric ${tcpUsageClass}">${player.tcpUtilization}%</span></td>
                            <td><span class="security-metric ${udpUsageClass}">${player.udpUtilization}%</span></td>
                            <td>${timeAgo}</td>
                        </tr>`);
                    });
                });
            }
            
            function showItemActions(type, id) {
                $("#selectedItemActions").show();
                $("#itemActionButtons").empty();
                
                if (type === "room") {
                    $("#itemActionButtons").append(`
                        <button class="btn btn-warning" id="closeRoomBtn">Close Room</button>
                    `);
                    
                    $("#closeRoomBtn").click(function() {
                        if (confirm("Are you sure you want to close this room?")) {
                            $.post("/Dashboard/CloseRoom", { roomId: id }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                } else if (type === "session") {
                    $("#itemActionButtons").append(`
                        <button class="btn btn-warning" id="disconnectPlayerBtn">Disconnect Player</button>
                    `);
                    
                    $("#disconnectPlayerBtn").click(function() {
                        if (confirm("Are you sure you want to disconnect this player?")) {
                            $.post("/Dashboard/DisconnectPlayer", { sessionId: id }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                }
            }
            
            function formatTimeSpan(timeString) {
                // The uptime is already formatted as a human-readable string
                return timeString;
            }
            
            function getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                
                if (diffSec < 60) return `${diffSec}s ago`;
                if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ago`;
                if (diffSec < 86400) return `${Math.floor(diffSec / 3600)}h ago`;
                return `${Math.floor(diffSec / 86400)}d ago`;
            }
            
            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            function loadUserManagementData() {
                loadUserStats();
                loadUsers();
                loadOnlineUsers();
            }
            
            function loadUserStats() {
                $.getJSON("/Dashboard/GetUserStats", function(data) {
                    if (data.success) {
                        $("#totalUsers").text(data.data.totalUsers || 0);
                        $("#activeUsers").text(data.data.activeUsers || 0);
                        $("#bannedUsers").text(data.data.bannedUsers || 0);
                    } else {
                        console.error("Failed to load user stats:", data.message);
                    }
                }).fail(function() {
                    console.error("Failed to load user stats");
                });
            }
            
            function loadUsers() {
                $.getJSON(`/Dashboard/GetAllUsers?page=${currentUserPage}&pageSize=${usersPerPage}`, function(data) {
                    if (data.success) {
                        displayUsers(data.data.users);
                        updateUsersPagination(data.data.totalCount);
                    } else {
                        console.error("Failed to load users:", data.message);
                    }
                }).fail(function() {
                    console.error("Failed to load users");
                });
            }
            
            function loadOnlineUsers() {
                $.getJSON("/Dashboard/GetOnlineUsers", function(data) {
                    if (data.success) {
                        $("#onlineUsers").text(data.data.length || 0);
                    } else {
                        console.error("Failed to load online users:", data.message);
                    }
                }).fail(function() {
                    console.error("Failed to load online users");
                });
            }
            
            function displayUsers(users) {
                let tbody = $("#usersTable tbody");
                tbody.empty();
                
                if (!users || users.length === 0) {
                    tbody.append('<tr><td colspan="7" class="text-center">No users found</td></tr>');
                    return;
                }
                
                users.forEach(function(user) {
                    let statusBadge = getStatusBadge(user.isBanned, user.isActive);
                    let createdDate = new Date(user.createdAt).toLocaleDateString();
                    let lastLoginDate = user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString() : 'Never';
                    
                    tbody.append(`<tr data-user-id="${user.id}">
                        <td>${escapeHtml(user.username)}</td>
                        <td>${escapeHtml(user.email)}</td>
                        <td>${statusBadge}</td>
                        <td>${createdDate}</td>
                        <td>${lastLoginDate}</td>
                        <td>${user.loginCount || 0}</td>
                        <td>
                            <div class="btn-group" role="group">
                                ${getUserActionButtons(user)}
                            </div>
                        </td>
                    </tr>`);
                });
                
                // Add event handlers for user actions
                addUserActionHandlers();
            }
            
            function getStatusBadge(isBanned, isActive) {
                if (isBanned) {
                    return '<span class="badge bg-danger">Banned</span>';
                } else if (isActive) {
                    return '<span class="badge bg-success">Active</span>';
                } else {
                    return '<span class="badge bg-secondary">Inactive</span>';
                }
            }
            
            function getUserActionButtons(user) {
                let buttons = [];
                
                if (user.isBanned) {
                    buttons.push(`<button class="btn btn-sm btn-success unban-user-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}">Unban</button>`);
                } else {
                    buttons.push(`<button class="btn btn-sm btn-warning ban-user-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}">Ban</button>`);
                }
                
                buttons.push(`<button class="btn btn-sm btn-info reset-password-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}">Reset Password</button>`);
                buttons.push(`<button class="btn btn-sm btn-secondary audit-log-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}">Audit Log</button>`);
                buttons.push(`<button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" data-username="${escapeHtml(user.username)}">Delete</button>`);
                
                return buttons.join(' ');
            }
            
            function addUserActionHandlers() {
                // Ban user
                $(".ban-user-btn").click(function() {
                    const userId = $(this).data("user-id");
                    const username = $(this).data("username");
                    const reason = prompt(`Enter ban reason for ${username}:`, "Violation of terms of service");
                    
                    if (reason && confirm(`Are you sure you want to ban ${username}?`)) {
                        $.post("/Dashboard/BanUserAccount", { 
                            userId: userId, 
                            reason: reason 
                        }, function(data) {
                            if (data.success) {
                                alert(`User ${username} has been banned.`);
                                loadUserManagementData();
                            } else {
                                alert(`Failed to ban user: ${data.message}`);
                            }
                        }).fail(function() {
                            alert("Failed to ban user due to a network error.");
                        });
                    }
                });
                
                // Unban user
                $(".unban-user-btn").click(function() {
                    const userId = $(this).data("user-id");
                    const username = $(this).data("username");
                    
                    if (confirm(`Are you sure you want to unban ${username}?`)) {
                        $.post("/Dashboard/UnbanUserAccount", { 
                            userId: userId 
                        }, function(data) {
                            if (data.success) {
                                alert(`User ${username} has been unbanned.`);
                                loadUserManagementData();
                            } else {
                                alert(`Failed to unban user: ${data.message}`);
                            }
                        }).fail(function() {
                            alert("Failed to unban user due to a network error.");
                        });
                    }
                });
                
                // Force password reset
                $(".reset-password-btn").click(function() {
                    const userId = $(this).data("user-id");
                    const username = $(this).data("username");
                    
                    if (confirm(`Are you sure you want to force a password reset for ${username}?`)) {
                        $.post("/Dashboard/ForcePasswordReset", { 
                            userId: userId 
                        }, function(data) {
                            if (data.success) {
                                alert(`Password reset initiated for ${username}. They will receive an email with reset instructions.`);
                            } else {
                                alert(`Failed to initiate password reset: ${data.message}`);
                            }
                        }).fail(function() {
                            alert("Failed to initiate password reset due to a network error.");
                        });
                    }
                });
                
                // Delete user
                $(".delete-user-btn").click(function() {
                    const userId = $(this).data("user-id");
                    const username = $(this).data("username");
                    
                    if (confirm(`Are you sure you want to permanently delete ${username}? This action cannot be undone.`)) {
                        const confirmation = prompt(`Type "${username}" to confirm deletion:`, "");
                        if (confirmation === username) {
                            $.post("/Dashboard/DeleteUserAccount", { 
                                userId: userId 
                            }, function(data) {
                                if (data.success) {
                                    alert(`User ${username} has been deleted.`);
                                    loadUserManagementData();
                                } else {
                                    alert(`Failed to delete user: ${data.message}`);
                                }
                            }).fail(function() {
                                alert("Failed to delete user due to a network error.");
                            });
                        } else if (confirmation !== null) {
                            alert("Username confirmation did not match. Deletion cancelled.");
                        }
                    }
                });
                
                // View audit log
                $(".audit-log-btn").click(function() {
                    const userId = $(this).data("user-id");
                    const username = $(this).data("username");
                    
                    $.getJSON(`/Dashboard/GetUserAuditLog?userId=${userId}`, function(data) {
                        if (data.success) {
                            showAuditLogModal(username, data.data);
                        } else {
                            alert(`Failed to load audit log: ${data.message}`);
                        }
                    }).fail(function() {
                        alert("Failed to load audit log due to a network error.");
                    });
                });
            }
            
            function updateUsersPagination(totalCount) {
                totalUserPages = Math.ceil(totalCount / usersPerPage);
                
                $("#usersPageInfo").text(`Page ${currentUserPage} of ${totalUserPages} (${totalCount} users)`);
                
                $("#prevUsersPage").prop('disabled', currentUserPage <= 1);
                $("#nextUsersPage").prop('disabled', currentUserPage >= totalUserPages);
            }
            
            function filterUsersTable(searchTerm) {
                $("#usersTable tbody tr").each(function() {
                    const row = $(this);
                    const username = row.find('td:nth-child(1)').text().toLowerCase();
                    const email = row.find('td:nth-child(2)').text().toLowerCase();
                    
                    if (username.includes(searchTerm) || email.includes(searchTerm)) {
                        row.show();
                    } else {
                        row.hide();
                    }
                });
            }
            
            function showAuditLogModal(username, auditEntries) {
                let modalHtml = `
                    <div class="modal fade" id="auditLogModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Audit Log - ${escapeHtml(username)}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Timestamp</th>
                                                    <th>Action</th>
                                                    <th>Details</th>
                                                    <th>IP Address</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;
                
                if (auditEntries && auditEntries.length > 0) {
                    auditEntries.forEach(function(entry) {
                        let timestamp = new Date(entry.timestamp).toLocaleString();
                        modalHtml += `
                            <tr>
                                <td>${timestamp}</td>
                                <td>${escapeHtml(entry.action)}</td>
                                <td>${escapeHtml(entry.details || '')}</td>
                                <td>${escapeHtml(entry.ipAddress || '')}</td>
                            </tr>
                        `;
                    });
                } else {
                    modalHtml += '<tr><td colspan="4" class="text-center">No audit entries found</td></tr>';
                }
                
                modalHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                $("#auditLogModal").remove();
                
                // Add modal to body
                $("body").append(modalHtml);
                
                // Show modal
                $("#auditLogModal").modal('show');
                
                // Clean up modal after hide
                $("#auditLogModal").on('hidden.bs.modal', function() {
                    $(this).remove();
                });
            }
        });
    </script>
</body>
</html>