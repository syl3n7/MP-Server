@{
    ViewData["Title"] = "Server Dashboard";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .dashboard-card {
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .refresh-button {
            margin-bottom: 20px;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .table-responsive {
            margin-bottom: 0;
        }
        .active-badge {
            background-color: #28a745;
            color: white;
        }
        .inactive-badge {
            background-color: #6c757d;
            color: white;
        }
        .admin-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .admin-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }
        .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn-danger {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">@ViewData["Title"]</h1>
        
        <button id="refreshButton" class="btn btn-primary refresh-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
            Refresh Data
        </button>
        
        <div class="admin-section">
            <h2 class="admin-title">Admin Controls</h2>
            <div class="admin-buttons">
                <button id="closeAllRoomsButton" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                    Close All Rooms
                </button>
                <button id="disconnectAllButton" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-x" viewBox="0 0 16 16">
                        <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m.256 7a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
                        <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m-.646-4.854.646.647.646-.647a.5.5 0 0 1 .708.708l-.647.646.647.646a.5.5 0 0 1-.708.708l-.646-.647-.646.647a.5.5 0 0 1-.708-.708l.647-.646-.647-.646a.5.5 0 0 1 .708-.708"/>
                    </svg>
                    Disconnect All Players
                </button>
            </div>
            <div id="selectedItemActions" style="display: none;">
                <h5>Selected Item Actions:</h5>
                <div class="admin-buttons" id="itemActionButtons">
                    <!-- Action buttons will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <!-- Stats cards will be inserted here -->
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">Active Rooms</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="roomsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Players</th>
                                        <th>Status</th>
                                        <th>Age</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Room data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">Active Sessions</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="sessionsTable">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Room</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Session data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Load data on page load
            loadAllData();
            
            // Set up auto-refresh every 10 seconds
            setInterval(loadAllData, 10000);
            
            // Manual refresh button
            $("#refreshButton").click(function() {
                loadAllData();
            });

            // Admin buttons
            $("#closeAllRoomsButton").click(function() {
                if (confirm("Are you sure you want to close all rooms?")) {
                    $.post("/Dashboard/CloseAllRooms", function(data) {
                        alert(data.message);
                        loadAllData();
                    });
                }
            });
            
            $("#disconnectAllButton").click(function() {
                if (confirm("Are you sure you want to disconnect all players?")) {
                    $.post("/Dashboard/DisconnectAllPlayers", function(data) {
                        alert(data.message);
                        loadAllData();
                    });
                }
            });
            
            function loadAllData() {
                loadStats();
                loadRooms();
                loadSessions();
            }
            
            function loadStats() {
                $.getJSON("/Dashboard/GetStats", function(data) {
                    // Format uptime nicely
                    let uptimeStr = formatTimeSpan(data.uptime);
                    
                    // Clear and rebuild stats container
                    $("#statsContainer").empty();
                    
                    // Add stat cards
                    $("#statsContainer").append(createStatCard("Server Uptime", uptimeStr));
                    $("#statsContainer").append(createStatCard("Active Sessions", data.activeSessions));
                    $("#statsContainer").append(createStatCard("Total Rooms", data.totalRooms));
                    $("#statsContainer").append(createStatCard("Active Games", data.activeGames));
                    $("#statsContainer").append(createStatCard("Players In Rooms", data.playersInRooms));
                });
            }
            
            function createStatCard(label, value) {
                return `<div class="stat-card">
                    <div class="stat-value">${value}</div>
                    <div class="stat-label">${label}</div>
                </div>`;
            }
            
            function loadRooms() {
                $.getJSON("/Dashboard/GetRooms", function(data) {
                    let tbody = $("#roomsTable tbody");
                    tbody.empty();
                    
                    if (data.length === 0) {
                        tbody.append('<tr><td colspan="5" class="text-center">No rooms available</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(room) {
                        let age = getTimeAgo(new Date(room.createdAt));
                        let statusBadge = room.isActive 
                            ? '<span class="badge active-badge">Active</span>' 
                            : '<span class="badge inactive-badge">Lobby</span>';
                            
                        tbody.append(`<tr data-id="${room.id}" data-type="room">
                            <td>${escapeHtml(room.name)}</td>
                            <td>${room.playerCount}</td>
                            <td>${statusBadge}</td>
                            <td>${age}</td>
                            <td>
                                <button class="btn btn-sm btn-danger closeRoomBtn" data-id="${room.id}">Close</button>
                            </td>
                        </tr>`);
                    });
                    
                    // Add event handlers for room actions
                    $(".closeRoomBtn").click(function() {
                        const roomId = $(this).data("id");
                        if (confirm("Are you sure you want to close this room?")) {
                            $.post("/Dashboard/CloseRoom", { roomId: roomId }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                    
                    // Add row click handler for room selection
                    $("#roomsTable tbody tr").click(function() {
                        $("#roomsTable tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        
                        const roomId = $(this).data("id");
                        showItemActions("room", roomId);
                    });
                });
            }
            
            function loadSessions() {
                $.getJSON("/Dashboard/GetSessions", function(data) {
                    let tbody = $("#sessionsTable tbody");
                    tbody.empty();
                    
                    if (data.length === 0) {
                        tbody.append('<tr><td colspan="4" class="text-center">No active sessions</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(session) {
                        let lastActivity = getTimeAgo(new Date(session.lastActivity));
                        let roomDisplay = session.currentRoomId ? session.currentRoomId : 'None';
                        
                        tbody.append(`<tr data-id="${session.id}" data-type="session">
                            <td>${escapeHtml(session.name)}</td>
                            <td>${escapeHtml(roomDisplay)}</td>
                            <td>${lastActivity}</td>
                            <td>
                                <button class="btn btn-sm btn-danger disconnectBtn" data-id="${session.id}">Disconnect</button>
                            </td>
                        </tr>`);
                    });
                    
                    // Add event handlers for session actions
                    $(".disconnectBtn").click(function() {
                        const sessionId = $(this).data("id");
                        if (confirm("Are you sure you want to disconnect this player?")) {
                            $.post("/Dashboard/DisconnectPlayer", { sessionId: sessionId }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                    
                    // Add row click handler for session selection
                    $("#sessionsTable tbody tr").click(function() {
                        $("#sessionsTable tbody tr").removeClass("table-primary");
                        $(this).addClass("table-primary");
                        
                        const sessionId = $(this).data("id");
                        showItemActions("session", sessionId);
                    });
                });
            }
            
            function showItemActions(type, id) {
                $("#selectedItemActions").show();
                $("#itemActionButtons").empty();
                
                if (type === "room") {
                    $("#itemActionButtons").append(`
                        <button class="btn btn-warning" id="closeRoomBtn">Close Room</button>
                    `);
                    
                    $("#closeRoomBtn").click(function() {
                        if (confirm("Are you sure you want to close this room?")) {
                            $.post("/Dashboard/CloseRoom", { roomId: id }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                } else if (type === "session") {
                    $("#itemActionButtons").append(`
                        <button class="btn btn-warning" id="disconnectPlayerBtn">Disconnect Player</button>
                    `);
                    
                    $("#disconnectPlayerBtn").click(function() {
                        if (confirm("Are you sure you want to disconnect this player?")) {
                            $.post("/Dashboard/DisconnectPlayer", { sessionId: id }, function(data) {
                                alert(data.message);
                                loadAllData();
                            });
                        }
                    });
                }
            }
            
            function formatTimeSpan(timeString) {
                // Parse ISO 8601 duration format
                const matches = timeString.match(/P(?:(\d+)D)?T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)(?:\.\d+)?S)?/);
                if (!matches) {
                    return timeString;
                }
                
                const days = matches[1] ? parseInt(matches[1]) : 0;
                const hours = matches[2] ? parseInt(matches[2]) : 0;
                const minutes = matches[3] ? parseInt(matches[3]) : 0;
                const seconds = matches[4] ? parseInt(matches[4]) : 0;
                
                // Format parts that exist
                let parts = [];
                if (days > 0) parts.push(`${days}d`);
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`);
                
                return parts.join(' ');
            }
            
            function getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                
                if (diffSec < 60) return `${diffSec}s ago`;
                if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ago`;
                if (diffSec < 86400) return `${Math.floor(diffSec / 3600)}h ago`;
                return `${Math.floor(diffSec / 86400)}d ago`;
            }
            
            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });
    </script>
</body>
</html>

<div class="row mb-4">
    <div class="col-md-12">
        <h2>Racing Server Dashboard</h2>
        <p class="lead">Server monitoring and management interface</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Server Statistics</h5>
            </div>
            <div class="card-body">
                <div id="stats-container">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Active Rooms</h5>
                    <button id="refresh-rooms" class="btn btn-sm btn-outline-light">Refresh</button>
                </div>
            </div>
            <div class="card-body">
                <div id="rooms-container">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Active Player Sessions</h5>
                    <button id="refresh-sessions" class="btn btn-sm btn-outline-light">Refresh</button>
                </div>
            </div>
            <div class="card-body">
                <div id="sessions-container">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmation-modal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmation-message">
                Are you sure you want to perform this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-action">Confirm</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let confirmationCallback = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initial data load
            loadStats();
            loadRooms();
            loadSessions();
            
            // Set up refresh buttons
            document.getElementById('refresh-rooms').addEventListener('click', loadRooms);
            document.getElementById('refresh-sessions').addEventListener('click', loadSessions);
            
            // Set up confirmation modal
            document.getElementById('confirm-action').addEventListener('click', function() {
                if (confirmationCallback) {
                    confirmationCallback();
                    confirmationCallback = null;
                }
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmation-modal'));
                modal.hide();
            });
            
            // Auto-refresh every 10 seconds
            setInterval(function() {
                loadStats();
                loadRooms();
                loadSessions();
            }, 10000);
        });
        
        async function loadStats() {
            try {
                const response = await fetch('/Dashboard/GetStats');
                
                if (response.ok) {
                    const stats = await response.json();
                    const container = document.getElementById('stats-container');
                    
                    // Format uptime
                    const uptime = stats.uptime;
                    const formattedUptime = `${Math.floor(uptime / 3600)}h ${Math.floor((uptime % 3600) / 60)}m ${uptime % 60}s`;
                    
                    container.innerHTML = `
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Server Uptime:</span>
                                <span class="badge bg-primary">${formattedUptime}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Active Sessions:</span>
                                <span class="badge bg-primary">${stats.activeSessions}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Rooms:</span>
                                <span class="badge bg-primary">${stats.totalRooms}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Active Games:</span>
                                <span class="badge bg-primary">${stats.activeGames}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Players In Rooms:</span>
                                <span class="badge bg-primary">${stats.playersInRooms}</span>
                            </li>
                        </ul>
                        <div class="mt-3">
                            <button id="close-all-rooms" class="btn btn-sm btn-warning me-2">Close All Rooms</button>
                            <button id="disconnect-all" class="btn btn-sm btn-danger">Disconnect All</button>
                        </div>
                    `;
                    
                    document.getElementById('close-all-rooms').addEventListener('click', function() {
                        showConfirmation(
                            'Are you sure you want to close all rooms? All players will be returned to the lobby.',
                            closeAllRooms
                        );
                    });
                    
                    document.getElementById('disconnect-all').addEventListener('click', function() {
                        showConfirmation(
                            'Are you sure you want to disconnect all players? This will close all connections.',
                            disconnectAllPlayers
                        );
                    });
                } else {
                    console.error('Failed to load stats:', response.statusText);
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }
        
        async function loadRooms() {
            try {
                const response = await fetch('/Dashboard/GetRooms');
                
                if (response.ok) {
                    const rooms = await response.json();
                    const container = document.getElementById('rooms-container');
                    
                    if (rooms.length === 0) {
                        container.innerHTML = '<p class="text-center">No active rooms</p>';
                        return;
                    }
                    
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Players</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    rooms.forEach(room => {
                        const createdAt = new Date(room.createdAt).toLocaleString();
                        const status = room.isActive ? 'Active' : 'Lobby';
                        const statusBadge = room.isActive ? 'success' : 'secondary';
                        
                        html += `
                            <tr>
                                <td>${room.name}</td>
                                <td>${room.playerCount}</td>
                                <td><span class="badge bg-${statusBadge}">${status}</span></td>
                                <td>${createdAt}</td>
                                <td>
                                    <a href="/Dashboard/RoomViewer/${room.id}" class="btn btn-sm btn-primary">View 3D</a>
                                    <button class="btn btn-sm btn-danger close-room" data-room-id="${room.id}">Close</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                    
                    // Add event listeners to close buttons
                    document.querySelectorAll('.close-room').forEach(button => {
                        button.addEventListener('click', function() {
                            const roomId = this.getAttribute('data-room-id');
                            showConfirmation(
                                'Are you sure you want to close this room? All players will be returned to the lobby.',
                                () => closeRoom(roomId)
                            );
                        });
                    });
                } else {
                    console.error('Failed to load rooms:', response.statusText);
                }
            } catch (err) {
                console.error('Error loading rooms:', err);
            }
        }
        
        async function loadSessions() {
            try {
                const response = await fetch('/Dashboard/GetSessions');
                
                if (response.ok) {
                    const sessions = await response.json();
                    const container = document.getElementById('sessions-container');
                    
                    if (sessions.length === 0) {
                        container.innerHTML = '<p class="text-center">No active sessions</p>';
                        return;
                    }
                    
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Session ID</th>
                                        <th>In Room</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sessions.forEach(session => {
                        const lastActivity = new Date(session.lastActivity).toLocaleString();
                        const inRoom = session.currentRoomId ? 'Yes' : 'No';
                        const inRoomBadge = session.currentRoomId ? 'success' : 'secondary';
                        
                        html += `
                            <tr>
                                <td>${session.name}</td>
                                <td><small>${session.id}</small></td>
                                <td><span class="badge bg-${inRoomBadge}">${inRoom}</span></td>
                                <td>${lastActivity}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger disconnect-player" data-session-id="${session.id}">Disconnect</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                    
                    // Add event listeners to disconnect buttons
                    document.querySelectorAll('.disconnect-player').forEach(button => {
                        button.addEventListener('click', function() {
                            const sessionId = this.getAttribute('data-session-id');
                            showConfirmation(
                                'Are you sure you want to disconnect this player?',
                                () => disconnectPlayer(sessionId)
                            );
                        });
                    });
                } else {
                    console.error('Failed to load sessions:', response.statusText);
                }
            } catch (err) {
                console.error('Error loading sessions:', err);
            }
        }
        
        async function closeRoom(roomId) {
            try {
                const response = await fetch('/Dashboard/CloseRoom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ roomId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadRooms();
                    loadSessions();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.message || response.statusText));
                }
            } catch (err) {
                console.error('Error closing room:', err);
                alert('Error: ' + err.message);
            }
        }
        
        async function closeAllRooms() {
            try {
                const response = await fetch('/Dashboard/CloseAllRooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadRooms();
                    loadSessions();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.message || response.statusText));
                }
            } catch (err) {
                console.error('Error closing all rooms:', err);
                alert('Error: ' + err.message);
            }
        }
        
        async function disconnectPlayer(sessionId) {
            try {
                const response = await fetch('/Dashboard/DisconnectPlayer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadSessions();
                    loadRooms();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.message || response.statusText));
                }
            } catch (err) {
                console.error('Error disconnecting player:', err);
                alert('Error: ' + err.message);
            }
        }
        
        async function disconnectAllPlayers() {
            try {
                const response = await fetch('/Dashboard/DisconnectAllPlayers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadSessions();
                    loadRooms();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.message || response.statusText));
                }
            } catch (err) {
                console.error('Error disconnecting all players:', err);
                alert('Error: ' + err.message);
            }
        }
        
        function showConfirmation(message, callback) {
            document.getElementById('confirmation-message').textContent = message;
            confirmationCallback = callback;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmation-modal'));
            modal.show();
        }
    </script>
}