@{
    ViewData["Title"] = "Racing Server Dashboard";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .dashboard-card {
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .refresh-button {
            margin-bottom: 20px;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .table-responsive {
            margin-bottom: 0;
        }
        .active-badge {
            background-color: #28a745;
            color: white;
        }
        .inactive-badge {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">@ViewData["Title"]</h1>
        
        <button id="refreshButton" class="btn btn-primary refresh-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
            Refresh Data
        </button>
        
        <div class="stats-container" id="statsContainer">
            <!-- Stats cards will be inserted here -->
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">Active Rooms</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="roomsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Players</th>
                                        <th>Status</th>
                                        <th>Age</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Room data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">Active Sessions</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="sessionsTable">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Room</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Session data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Load data on page load
            loadAllData();
            
            // Set up auto-refresh every 10 seconds
            setInterval(loadAllData, 10000);
            
            // Manual refresh button
            $("#refreshButton").click(function() {
                loadAllData();
            });
            
            function loadAllData() {
                loadStats();
                loadRooms();
                loadSessions();
            }
            
            function loadStats() {
                $.getJSON("/Dashboard/GetStats", function(data) {
                    // Format uptime nicely
                    let uptimeStr = formatTimeSpan(data.uptime);
                    
                    // Clear and rebuild stats container
                    $("#statsContainer").empty();
                    
                    // Add stat cards
                    $("#statsContainer").append(createStatCard("Server Uptime", uptimeStr));
                    $("#statsContainer").append(createStatCard("Active Sessions", data.activeSessions));
                    $("#statsContainer").append(createStatCard("Total Rooms", data.totalRooms));
                    $("#statsContainer").append(createStatCard("Active Games", data.activeGames));
                    $("#statsContainer").append(createStatCard("Players In Rooms", data.playersInRooms));
                });
            }
            
            function createStatCard(label, value) {
                return `<div class="stat-card">
                    <div class="stat-value">${value}</div>
                    <div class="stat-label">${label}</div>
                </div>`;
            }
            
            function loadRooms() {
                $.getJSON("/Dashboard/GetRooms", function(data) {
                    let tbody = $("#roomsTable tbody");
                    tbody.empty();
                    
                    if (data.length === 0) {
                        tbody.append('<tr><td colspan="4" class="text-center">No rooms available</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(room) {
                        let age = getTimeAgo(new Date(room.createdAt));
                        let statusBadge = room.isActive 
                            ? '<span class="badge active-badge">Active</span>' 
                            : '<span class="badge inactive-badge">Lobby</span>';
                            
                        tbody.append(`<tr>
                            <td>${escapeHtml(room.name)}</td>
                            <td>${room.playerCount}</td>
                            <td>${statusBadge}</td>
                            <td>${age}</td>
                        </tr>`);
                    });
                });
            }
            
            function loadSessions() {
                $.getJSON("/Dashboard/GetSessions", function(data) {
                    let tbody = $("#sessionsTable tbody");
                    tbody.empty();
                    
                    if (data.length === 0) {
                        tbody.append('<tr><td colspan="3" class="text-center">No active sessions</td></tr>');
                        return;
                    }
                    
                    data.forEach(function(session) {
                        let lastActivity = getTimeAgo(new Date(session.lastActivity));
                        let roomDisplay = session.currentRoomId ? session.currentRoomId : 'None';
                        
                        tbody.append(`<tr>
                            <td>${escapeHtml(session.name)}</td>
                            <td>${escapeHtml(roomDisplay)}</td>
                            <td>${lastActivity}</td>
                        </tr>`);
                    });
                });
            }
            
            function formatTimeSpan(timeString) {
                // Parse ISO 8601 duration format
                const matches = timeString.match(/P(?:(\d+)D)?T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)(?:\.\d+)?S)?/);
                if (!matches) {
                    return timeString;
                }
                
                const days = matches[1] ? parseInt(matches[1]) : 0;
                const hours = matches[2] ? parseInt(matches[2]) : 0;
                const minutes = matches[3] ? parseInt(matches[3]) : 0;
                const seconds = matches[4] ? parseInt(matches[4]) : 0;
                
                // Format parts that exist
                let parts = [];
                if (days > 0) parts.push(`${days}d`);
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`);
                
                return parts.join(' ');
            }
            
            function getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                
                if (diffSec < 60) return `${diffSec}s ago`;
                if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ago`;
                if (diffSec < 86400) return `${Math.floor(diffSec / 3600)}h ago`;
                return `${Math.floor(diffSec / 86400)}d ago`;
            }
            
            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });
    </script>
</body>
</html>